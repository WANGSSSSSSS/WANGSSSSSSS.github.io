---
title: 虚拟内存（一）
date: 2021-03-29 19:20:53
categories:
- os
tags:
- os
cover: /images/image-20210329193457247.png
---

## 内存系统

### 地址空间

**物理地址**：主存被组织成一个数组，每个字节有唯一的地址，这个地址被称为物理地址，存在于物理系统中

<img src="../images/image-20210329192310898.png" alt="物理地址" style="zoom:50%;" />

**虚拟地址**：现代处理器采用虚拟地址来进行寻址，虚拟地址通过内存管理单元转换为物理地址，虚拟地址一般是线性地址，便于控制

<img src="../images/image-20210329192458247.png" alt="虚拟地址架构" style="zoom:50%;" />

​	MMU：内存管理单元，执行地址转换

虚拟内存与物理内存的联系可以用映射来表达：

<img src="../images/image-20210329194116858.png" alt="虚拟地址映射" style="zoom:50%;" />

### 地址转换

#### 一级页表转换

页表基地址存放在基地址寄存器中，这里存放着页表的位置，输入的虚拟地址部分用来索引页表中的项，其余部分作为偏移量，物理页偏移量一般等于虚拟页偏移量

<img src="../images/image-20210329193054271.png" alt="使用一级页表" style="zoom:67%;" />

#### 多级页表

下图为i7 中的四级页表结构，cr3寄存器存储第一级页表位置，通过虚拟地址中的部分地址来索引其余页表位置，其余部分作为偏移量

<img src="../images/image-20210329193457247.png" alt="corei7中的内存体系" style="zoom:67%;" />

在i7的机构下，有多级cache存在，如果命中就立即返回，如果没有命中，则向下一级内存进发，如果连主存也没有命中，这只能从硬盘上取了

### Linux 虚拟内存系统

<img src="../images/image-20210329194402130.png" alt="image-20210329194402130" style="zoom: 67%;" />

#### linux中的内存组织

linux中的任务结构体包含内存管理块，mm中有第一级页表的偏移，以及按照链表组织的内存段

<img src="../images/image-20210329194714152.png" alt="linux 内存组织" style="zoom:67%;" />

**代码：**

#### linux中的缺页异常

<img src="../images/image-20210329194844391.png" alt="缺页异常处理" style="zoom: 67%;" />